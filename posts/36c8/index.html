<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#33363b"><meta name="msapplication-TileColor" content="#33363b"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-145268421-1"></script><script>window.dataLayer=window.dataLayer||[];var gtag=function(){dataLayer.push(arguments)};gtag("js",new Date),gtag("config","UA-145268421-1")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?265c38da225b520620b94857150b4d2c";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><meta name="keywords" content="Life, ARIA, Hexo"><link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-144x144.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png"><link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#33363b"><link rel="manifest" href="/favicons/site.webmanifest"><meta name="msapplication-config" content="/favicons/browserconfig.xml"><link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/index.css"><link rel="stylesheet" type="text/css" href="/css/sidebar.css"><link rel="stylesheet" type="text/css" href="/css/page.css"><link rel="stylesheet" type="text/css" href="/css/post.css"><link rel="stylesheet" type="text/css" href="/css/custom.css"><link rel="stylesheet" type="text/css" href="/css/atom-one-dark.css"><link rel="stylesheet" type="text/css" href="/css/lightgallery.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><script defer="defer" type="text/javascript" src="/js/util.js"></script><script defer="defer" type="text/javascript" src="/js/clipboard.min.js"></script><script defer="defer" type="text/javascript" src="/js/scrollspy.js"></script><script defer="defer" type="text/javascript" src="/js/fontawesome-all.min.js"></script><script defer="defer" type="text/javascript" src="/js/lightgallery.min.js"></script><script defer="defer" type="text/javascript" src="/js/lg-fullscreen.min.js"></script><script defer="defer" type="text/javascript" src="/js/lg-hash.min.js"></script><script defer="defer" type="text/javascript" src="/js/lg-pager.min.js"></script><script defer="defer" type="text/javascript" src="/js/lg-thumbnail.min.js"></script><script defer="defer" type="text/javascript" src="/js/lg-zoom.min.js"></script><script defer="defer" type="text/javascript" src="/js/search.js"></script><script type="text/javascript">$(document).ready(function(){var e="search.xml";0===e.length&&(e="search.xml"),searchFunc("/"+e,"search-input","search-result")})</script><script defer="defer" type="text/javascript" src="/js/index.js"></script><script type="text/javascript">$(document).ready(function(){var t=$(".post figure.highlight");(t.length?($(t).each(function(t,i){}),new ClipboardJS("button.copy",{target:function(t){return t.nextElementSibling.firstChild.firstChild.firstChild.lastChild.firstChild.firstChild}})):(t=$(".post pre code"),$(t).each(function(t,i){}),new ClipboardJS("button.copy",{target:function(t){return t.nextElementSibling.firstChild}}))).on("success",function(t){t.clearSelection();var i=t.trigger;i.innerHTML="已复制",$(i).addClass("copied"),setTimeout(function(){i.innerHTML="复制",$(i).removeClass("copied")},1500)})})</script><script defer="defer" type="text/javascript" src="/js/custom.js"></script><title>Delta Lake 全面解析 | 科技洞见 - 技术练达即文章</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN" data-spy="scroll" data-target=".list-group"><header id="header" class="header" style="background:#33363b"><div class="container"><div class="header-container"><div class="header-title"><h1 class="title"><a href="/">科技洞见</a></h1><h2 class="subtitle">技术练达即文章</h2></div></div><nav id="nav" class="nav"><a id="nav-toggle" class="nav-toggle" aria-hidden="true"><i class="fas fa-bars" aria-label="切换导航栏"></i></a><ul id="menu" role="menubar" aria-hidden="false"><li role="menuitem"><a href="/"><i class="fas fa-home"></i><span class="menu-text">首页</span></a></li><li role="menuitem"><a href="/archives/"><i class="fas fa-archive"></i><span class="menu-text">归档</span></a></li><li role="menuitem"><a href="/categories/"><i class="fas fa-th-list"></i><span class="menu-text">分类</span></a></li><li role="menuitem"><a href="/tags/"><i class="fas fa-tags"></i><span class="menu-text">标签</span></a></li><li role="menuitem"><a href="/about/"><i class="fas fa-user-edit"></i><span class="menu-text">关于</span></a></li></ul></nav></div></header><main id="main" class="main"><div class="container"><div class="main-container"><div class="content"><div id="post" class="page"><article class="article post card" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://technologiesinsight.com/posts/36c8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="KevinZhang"><meta itemprop="description" content="技术练达即文章"><meta itemprop="image" content="/images/ava1.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="科技洞见"></span></div><header class="post-header"><h1 class="post-title" itemprop="name headline">Delta Lake 全面解析</h1><div class="post-meta"><span class="post-date"><i class="far fa-calendar-plus"></i> <span><time title="post-date" itemprop="dateCreated datePublished" datetime="2019-08-05T15:33:16+08:00">2019-08-05 15:33:16</time></span></span> <span class="post-meta-divider divider">|</span><span class="post-categories"><i class="far fa-folder-open"></i> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a></span><i class="fas fa-angle-right"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/大数据/Spark/" itemprop="url" rel="index"><span itemprop="name">Spark</span></a></span></span> <span class="post-meta-divider divider">|</span><span class="post-comment-count"><i class="far fa-comments"></i><span><a href="/posts/36c8/#disqus_thread" itemprop="discussionUrl"><span class="post-comment-count disqus-comment-count" data-disqus-identifier="posts/36c8/" itemprop="commentCount"></span></a></span></span></div></header><main class="post-main" itemprop="articleBody"><p>Delta Lake 在 Spark + AI Summit 2019 宣布开源，引起了不小的震动，这到底是何方神圣？本文将从什么是 Delta Lake、它有那些特点、它是如何实现的，以及它的出现对未来大数据领域和大数据从业者可能有什么影响这些角度，全面解析这一新一代的文件存储层。</p><a id="more"></a><h1 id="delta-lake"><a class="markdownIt-Anchor" href="#delta-lake"></a> Delta Lake</h1><p><a href="https://delta.io/" rel="external nofollow noopener noreferrer" target="_blank">Delta Lake</a> 是 Databricks (俗称&quot;砖厂&quot;) 开源的一个文件存储层,目前运行在 Spark 上。它主要提供了以下功能（摘自官网）：</p><ol><li>ACID 事务(ACID transactions)</li><li>Schema 相关特性：Schema 本地存储、支持 Schema 约束、Schema 演变 (Scalable Metadata Handling、Schema Enforcement、Schema Evolution)</li><li>数据版本控制 (Time Travel (data versioning))</li><li>支持数据更新删除 （Updates and Deletes）</li><li>统一了流数据和批处理数据落地 (Unified batch and streaming sink)</li></ol><h1 id="特性详细介绍"><a class="markdownIt-Anchor" href="#特性详细介绍"></a> 特性详细介绍</h1><p>下面将会对Delta Lake 的特性详细介绍。</p><h2 id="acid-事务"><a class="markdownIt-Anchor" href="#acid-事务"></a> ACID 事务</h2><p>这里的 ACID 就是指原子性、一致性、隔离性和持久性。一致性、持久性之前就已经实现，这里主要是解释一下原子性和隔离性。<br> <strong>原子性：</strong> 一个事务要么成功要么失败，不存在中间状态。这一个特性对于数据的准确性，特别是出现失败时候仍然保持准确性至关重要。当 job 失败时已经写入的数据会自动回滚到未写入的状态，不需要手工处理。<br> <strong>隔离性：</strong> 基于<a href="https://en.wikipedia.org/wiki/Optimistic_concurrency_control" rel="external nofollow noopener noreferrer" target="_blank">乐观的并发控制</a>实现可序列花的隔离级别。乐观的并发控制在竞争不很激烈的情况下，会提高性能。可序列花的隔离级别保证了即使并发执行读或写操作，仍然保证像在串行读写一样。<br> 具体的，Delta Lake 支持并发读取、并发追加(追加的内容不依赖于任何的读取已经存在的数据)，但不支持并发修改，出现并发修改会抛出 concurrent modification exception。<br> 隔离性保证无论是并发批处理操作、流操作或者是批流并发操作，数据都是准确的</p><h2 id="schema-相关特性"><a class="markdownIt-Anchor" href="#schema-相关特性"></a> Schema 相关特性</h2><p>Hive Metastore 一般用中心化的存储（如 MySQL） 对 Schema 进行管理。在 Schema 数量特别巨大时(比如分区数特别多)，由于中心化存储伸缩性是非线性的，容易形成瓶颈。<br> Delta Lake 将元数据同样视为数据，保存在文件中，使得对大数据的处理能力可以运用在处理元数据上。<br> 由于元数据由文件进行管理，所以有了更大的灵活性和可能性，Schema Enforcement （强制检验数据的 Schema，不通过则拒绝），Schema Evolution （根据数据自动更改 Schema，无需手动指定）</p><h2 id="数据版本控制"><a class="markdownIt-Anchor" href="#数据版本控制"></a> 数据版本控制</h2><p>事务都有了，实现版本控制也是顺带的事。Delta Lake 可以读取某个版本的数据或者恢复数据到某一个历史版本。</p><h2 id="支持数据更新删除"><a class="markdownIt-Anchor" href="#支持数据更新删除"></a> 支持数据更新删除</h2><p>支持包括单条数据、批量数据的更新和删除</p><h2 id="统一了流数据和批处理数据落地"><a class="markdownIt-Anchor" href="#统一了流数据和批处理数据落地"></a> 统一了流数据和批处理数据落地</h2><p>Delta Lake 还统一了流数据和批处理数据落地，而不需要最开始提到的 Lambda 架构。极大的简化了系统的复杂性</p><h1 id="delta-lake-快速体验"><a class="markdownIt-Anchor" href="#delta-lake-快速体验"></a> Delta Lake 快速体验</h1><p>使用 Delta Lake 需要 Spark 2.4.2 及以上版本，如果仅仅想体验一下，可以使用 Docker 版 Spark</p><ul><li>安装 Spark</li></ul><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d --name spark-master -h spark-master \<br>-p 8080:8080 \<br>-p 7077:7077 \<br>-p 4040:4040  \<br>-e ENABLE_INIT_DAEMON=<span class="hljs-literal">false</span>  \<br>bde2020/spark-master:2.4.3-hadoop2.7<br><br><br>docker run -d --name spark-worker-1 \<br>-p 8081:8081 \<br>--link spark-master:spark-master \<br>-e ENABLE_INIT_DAEMON=<span class="hljs-literal">false</span> \<br>bde2020/spark-worker:2.4.3-hadoop2.7<br></code></pre></td></tr></table></figure><ul><li>进入 Spark Shell</li></ul><figure class="hljs highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">exec</span> -it spark-master  /spark/bin/spark-shell --packages io.delta:delta-core_2.11:0.3.0<br></code></pre></td></tr></table></figure><ul><li>创建 Delta Table</li></ul><figure class="hljs highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> data = spark.range(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)<br>data.write.format(<span class="hljs-string">"delta"</span>).save(<span class="hljs-string">"/tmp/delta-table"</span>)<br></code></pre></td></tr></table></figure><ul><li>其他更多实践请参阅 <a href="https://docs.delta.io/latest/quick-start.html" rel="external nofollow noopener noreferrer" target="_blank">官方文档</a></li></ul><h1 id="实现原理"><a class="markdownIt-Anchor" href="#实现原理"></a> 实现原理</h1><h2 id="delta-lake-的文件结构"><a class="markdownIt-Anchor" href="#delta-lake-的文件结构"></a> Delta Lake 的文件结构</h2><p>Delta Lake 在原有的 Parquet 文件的基础上，增加了 _delta_log 文件夹。_delta_log 文件夹内包含 json 文件和 checkpoint.parquet 文件。<br> <img src="/images/delta-lake-folder.jpg" alt="_delta_log 结构"></p><ul><li>这些 json 文件称为 transaction log。其文件名是递增的，数字代表版本。每一个文件代表一个事务，存储了 Schema 信息，对文件的操作等。</li></ul><figure class="hljs highlight"><figcaption><span>transaction log 内容</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;"commitInfo":&#123;"timestamp":1563414817197,"operation":"WRITE","operationParameters":&#123;"mode":"ErrorIfExists","partitionBy":"[]"&#125;,"isBlindAppend":true&#125;&#125;<br>&#123;"protocol":&#123;"minReaderVersion":1,"minWriterVersion":2&#125;&#125;<br>&#123;"metaData":&#123;"id":"72e1fda6-6860-477a-94bf-924c5935818b","format":&#123;"provider":"parquet","options":&#123;&#125;&#125;,"schemaString":"&#123;\"type\":\"struct\",\"fields\":[&#123;\"name\":\"id\",\"type\":\"long\",\"nullable\":true,<br>\"metadata\":&#123;&#125;&#125;]&#125;","partitionColumns":[],"configuration":&#123;&#125;,"createdTime":1563414816435&#125;&#125;<br>&#123;"add":&#123;"path":"part-00000-90a5fe90-b039-4cce-92be-ff70abc6aeac-c000.snappy.parquet","partitionValues":&#123;&#125;,"size":263,"modificationTime":1563414816000,"dataChange":true&#125;&#125;<br></code></pre></td></tr></table></figure><ul><li>checkpoint.parquet 是检查点，可以加速数据的读取</li></ul><p>在<strong>没有检查点的情况下</strong> ，需要从头开始读取 transaction log，重放每一个 transaction log 的文件操作，才会得到所需要的结果，有了检查点，获取数据的某一个版本时，只需要从距离版本最近的检查点，重放版本和检查点的 transaction log 即可得到指定版本的数据</p><h2 id="实现原子操作"><a class="markdownIt-Anchor" href="#实现原子操作"></a> 实现原子操作</h2><p><strong>写入失败时：</strong> 事务不提交，不形成 transaction log 文件，本次事务写入的文件就不会纳入到当前表中。<br> <strong>写入成功时：</strong> 事务提交，transaction log 原子的生成，于是数据变持久性存在于当前 delta table 中</p><h2 id="实现可序列化隔离级别"><a class="markdownIt-Anchor" href="#实现可序列化隔离级别"></a> 实现可序列化隔离级别</h2><p>可序列化隔离的实现基于<a href="https://zh.wikipedia.org/zh-hans/%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6" rel="external nofollow noopener noreferrer" target="_blank">乐观并发控制</a><br> <strong>并发修改的情况：</strong> 事务开始是读取最新版本的数据，输出数据产生一个新的版本，在事务提交之前，检查是否还有其他提交的 transaction log 与本次提交有冲突，如果有冲突，抛出 ConcurrentModificationException。写入的数据不会提交，因此不会生效<br> <strong>并发追加的情况：</strong> 与之类似，不同点在于发现冲突时会检查 Schema 是否变化，如果没有变化，会自动重试，不会抛出异常</p><h1 id="关于-delta-lake-的思考"><a class="markdownIt-Anchor" href="#关于-delta-lake-的思考"></a> 关于 Delta Lake 的思考</h1><p>像 Delta Lake、 Netflix 的 iceberg 这种新一代的文件格式的出现，解决了大数据发展中批流存储不统一、不支持事务等等痛点。</p><p>Spark 诞生之初，就在计算模型上实现了批处理和流处理的统一，现在 Delta Lake 的出现，在存储层也将实现统一。<br> 批流处理的大一统后不但意味着可以消除像 Lambda 架构这种变通的解决方案，而且目前常用的基于批处理的数据加工方式也可也会被流式的数据处理方式所取代。再加上可以支持事务。</p><p>届时，开发者可以把更多精力放在&quot;如何从数据中提取有用的信息&quot;这样一件事情上，更多的关注数据流应该如何变化，而不是关注任务说明时候执行，任务失败了怎么重试等等问题。</p><p>所以像 Lambda 架构、各种数据准确性检验任务、不同系统的数据导入工具、调度执行批处理任务等等，这些在大数据领域习以为常的解决方案会成为历史。</p><p>一方面这当然是好事，开发者可以各司其职，大数据系统也会更加统一<br> 但另一方面，技术的升级往往会替代一部分人，而且会让我们之前的经验一文不值。所以需要我们更需要思考如何提升自己，让自己驾驭技术，而不是让技术取代自己，就像很多职业都需要自思考如何被人工智能取代一样。</p></main><footer class="post-footer"><div class="post-tags"><a class="post-tag button" href="/tags/原创/" rel="tag"><i class="fas fa-tags"></i> 原创</a><a class="post-tag button" href="/tags/Spark/" rel="tag"><i class="fas fa-tags"></i> Spark</a><a class="post-tag button" href="/tags/Delta-Lake/" rel="tag"><i class="fas fa-tags"></i> Delta Lake</a></div></footer></article><nav class="page-nav"><div class="page-nav-next page-nav-item"><a href="/posts/1a8c/" rel="next" title="大数据系统下的 Lambda 架构"><i class="fas fa-angle-left"></i> <span class="nav-title">大数据系统下的 Lambda 架构</span></a></div><div class="page-nav-prev page-nav-item"></div></nav><div class="comments" id="comments"><script defer="defer" id="dsq-count-scr" src="//technologiesinsight.disqus.com/count.js"></script><div id="disqus_thread" class="disqus_thread"></div><script type="text/javascript">var disqus_config=function(){this.page.url="https://technologiesinsight.com/posts/36c8/",this.page.identifier="posts/36c8/"};!function(){var t=document,e=t.createElement("script");e.src="https://technologiesinsight.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script></div></div></div><aside class="sidebar" id="sidebar" style="background:url(/images/background.png)"><div class="search"><div class="form-group"><i class="fas fa-search"></i> <input type="search" id="search-input" name="q" results="0" placeholder="搜索" class="form-control"></div></div><div class="search-result-box" id="search-result"></div><div class="info sidebar-item" id="info"> <img class="author-avatar" src="/images/ava1.jpg" alt="KevinZhang"><h1 class="author-name">KevinZhang</h1><h2 class="author-description">技术练达即文章</h2><div class="site-count"><div class="archives-count count-block"><div class="site-count-title">归档</div><div><a href="/archives/">5</a></div></div><div class="categories-count count-block"><div class="site-count-title">分类</div><div><a href="/categories/">4</a></div></div><div class="tags-count count-block"><div class="site-count-title">标签</div><div><a href="/tags/">8</a></div></div></div></div><div class="sidebar-sticky"><hr><div class="post-toc sidebar-item" id="toc-div"><div><i class="fas fa-list-ol"></i>文章目录</div><div class="post-toc-content"><ol class="list-group toc"><li class="toc-item toc-level-1"> <a class="list-group-item toc-link" href="#delta-lake"><span class="toc-text">Delta Lake</span></a></li><li class="toc-item toc-level-1"> <a class="list-group-item toc-link" href="#特性详细介绍"><span class="toc-text">特性详细介绍</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-2"> <a class="list-group-item toc-link" href="#acid-事务"><span class="toc-text">ACID 事务</span></a></li><li class="toc-item toc-level-2"> <a class="list-group-item toc-link" href="#schema-相关特性"><span class="toc-text">Schema 相关特性</span></a></li><li class="toc-item toc-level-2"> <a class="list-group-item toc-link" href="#数据版本控制"><span class="toc-text">数据版本控制</span></a></li><li class="toc-item toc-level-2"> <a class="list-group-item toc-link" href="#支持数据更新删除"><span class="toc-text">支持数据更新删除</span></a></li><li class="toc-item toc-level-2"> <a class="list-group-item toc-link" href="#统一了流数据和批处理数据落地"><span class="toc-text">统一了流数据和批处理数据落地</span></a></li></ol></li><li class="toc-item toc-level-1"> <a class="list-group-item toc-link" href="#delta-lake-快速体验"><span class="toc-text">Delta Lake 快速体验</span></a></li><li class="toc-item toc-level-1"> <a class="list-group-item toc-link" href="#实现原理"><span class="toc-text">实现原理</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-2"> <a class="list-group-item toc-link" href="#delta-lake-的文件结构"><span class="toc-text">Delta Lake 的文件结构</span></a></li><li class="toc-item toc-level-2"> <a class="list-group-item toc-link" href="#实现原子操作"><span class="toc-text">实现原子操作</span></a></li><li class="toc-item toc-level-2"> <a class="list-group-item toc-link" href="#实现可序列化隔离级别"><span class="toc-text">实现可序列化隔离级别</span></a></li></ol></li><li class="toc-item toc-level-1"> <a class="list-group-item toc-link" href="#关于-delta-lake-的思考"><span class="toc-text">关于 Delta Lake 的思考</span></a></li></ol></div></div><hr><div class="social-link sidebar-item"><div><i class="far fa-address-card"></i>社交链接<p></p></div><ul><li><i class="fas fa-envelope"></i><a href="mailto:kevin.zhang.me@gmail.com" target="_blank" rel="external nofollow noopener noreferrer">E-Mail</a></li><li><i class="fab fa-github"></i><a href="https://github.com/KevinZhangMe" target="_blank" rel="external nofollow noopener noreferrer">GitHub</a></li></ul></div></div></aside></div></div></main><footer id="footer" class="footer" style="background:#33363b"><div class="container"><div class="back-to-top"> <button id="back-to-top"><i class="fas fa-angle-double-up" aria-label="回到顶部"></i></button></div><div class="footer-container"><div class="footer-left"><div class="copyright"> <span class="author">KevinZhang</span><span class="year"><i class="far fa-copyright"></i>2019</span></div></div><div class="footer-right"><div class="custom-info"></div><div class="powered-by"> 由 <a href="https://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a> 强力驱动</div></div></div></div></footer></body></html>